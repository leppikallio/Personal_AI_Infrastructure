#!/usr/bin/env bun

import { readFileSync } from "fs";
import { homedir } from "os";
import { join } from "path";

// Parse CLI arguments
const args = process.argv.slice(2);
let model = "sonar";
let maxTokens = 4096;
let temperature = 0.2;
let showCitations = false;
let debug = false;
let query = "";

for (let i = 0; i < args.length; i++) {
  if (args[i] === "-m" || args[i] === "--model") {
    model = args[++i];
  } else if (args[i] === "-t" || args[i] === "--tokens") {
    maxTokens = parseInt(args[++i]);
  } else if (args[i] === "--temp" || args[i] === "--temperature") {
    temperature = parseFloat(args[++i]);
  } else if (args[i] === "-c" || args[i] === "--citations") {
    showCitations = true;
  } else if (args[i] === "-d" || args[i] === "--debug") {
    debug = true;
  } else if (args[i] === "-h" || args[i] === "--help") {
    console.log(`Usage: perplexity [options] "query"

Options:
  -m, --model <model>    Model to use (default: sonar)
                         Available: sonar, sonar-pro, sonar-reasoning, sonar-reasoning-pro
  -t, --tokens <num>     Max tokens in response (default: 4096)
  --temp <num>           Temperature 0-2 (default: 0.2)
  -c, --citations        Show citation URLs
  -d, --debug            Show API request/response details and timing
  -h, --help             Show this help message

Examples:
  perplexity "What is TypeScript?"
  perplexity -m sonar-pro "Explain quantum computing"
  perplexity -c -t 8000 "Latest AI developments"
  perplexity -d "Debug mode test"
`);
    process.exit(0);
  } else if (!args[i].startsWith("-")) {
    query = args[i];
  }
}

if (!query) {
  console.error("Error: No query provided");
  console.error('Usage: perplexity "your question"');
  process.exit(1);
}

// Load API key from ~/.env
function loadApiKey(): string {
  const envPath = join(homedir(), ".env");
  try {
    const envContent = readFileSync(envPath, "utf-8");
    const match = envContent.match(/PERPLEXITY_API_KEY=(.+)/);
    if (match) {
      return match[1].trim();
    }
  } catch (e) {
    // File doesn't exist or can't be read
  }

  // Fallback to environment variable
  if (process.env.PERPLEXITY_API_KEY) {
    return process.env.PERPLEXITY_API_KEY;
  }

  console.error("Error: PERPLEXITY_API_KEY not found in ~/.env or environment");
  process.exit(1);
}

const apiKey = loadApiKey();

// Make API request
async function search(): Promise<void> {
  const requestBody: any = {
    model,
    max_tokens: maxTokens,
    temperature,
    messages: [
      {
        role: "system",
        content: "You are a helpful research assistant. Provide comprehensive, well-sourced answers."
      },
      {
        role: "user",
        content: query
      }
    ]
  };

  // Request citations from API when -c flag is used
  if (showCitations) {
    requestBody.return_citations = true;
  }

  if (debug) {
    console.error("\n--- DEBUG: Request ---");
    console.error(`URL: https://api.perplexity.ai/chat/completions`);
    console.error(`Method: POST`);
    console.error(`Model: ${model}`);
    console.error(`Max Tokens: ${maxTokens}`);
    console.error(`Temperature: ${temperature}`);
    console.error(`Return Citations: ${showCitations}`);
    console.error(`Query: ${query}`);
    console.error(`API Key: ${apiKey.slice(0, 10)}...${apiKey.slice(-4)}`);
    console.error("----------------------\n");
  }

  const startTime = Date.now();

  const response = await fetch("https://api.perplexity.ai/chat/completions", {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${apiKey}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify(requestBody),
  });

  const endTime = Date.now();
  const duration = endTime - startTime;

  if (debug) {
    console.error(`--- DEBUG: Response ---`);
    console.error(`Status: ${response.status} ${response.statusText}`);
    console.error(`Duration: ${duration}ms`);
    console.error("-----------------------\n");
  }

  if (!response.ok) {
    const error = await response.text();
    console.error(`Error: API request failed (${response.status})`);
    console.error(error);
    process.exit(1);
  }

  const data = await response.json();

  if (debug) {
    console.error("--- DEBUG: Raw Response ---");
    console.error(JSON.stringify(data, null, 2));
    console.error("---------------------------\n");

    console.error("--- DEBUG: Usage ---");
    if (data.usage) {
      console.error(`Prompt tokens: ${data.usage.prompt_tokens}`);
      console.error(`Completion tokens: ${data.usage.completion_tokens}`);
      console.error(`Total tokens: ${data.usage.total_tokens}`);
    }
    if (data.id) {
      console.error(`Request ID: ${data.id}`);
    }
    console.error("--------------------\n");
  }

  if (data.error) {
    console.error("Error:", data.error.message || data.error);
    process.exit(1);
  }

  const content = data.choices?.[0]?.message?.content;
  if (content) {
    console.log(content);

    // Show citations if requested and available
    if (showCitations && data.citations && data.citations.length > 0) {
      console.log("\n--- Citations ---");
      data.citations.forEach((url: string, i: number) => {
        console.log(`[${i + 1}] ${url}`);
      });
    }
  } else {
    console.error("Error: No response content received");
    process.exit(1);
  }
}

search();
